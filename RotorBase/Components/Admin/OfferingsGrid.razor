@using System.Globalization
@using System.Linq
@inject HttpClient Http

<table class="table">
    <thead>
        <tr>
            <th class="w-[24%]">Vendor</th>
            <th class="text-right w-[14%]">Price</th>
            <th class="w-[12%]">Currency</th>
            <th>URL</th>
            <th class="w-[16%]">Availability</th>
            <th class="text-right w-[6%]"></th>
        </tr>
    </thead>
    <tbody>
        @for (var i = 0; i < Items.Count; i++)
        {
            var row = Items[i];
            <tr @key="row">
                <td>
                    <input class="input h-9" list="@_vendorListId" value="@row.VendorName" @oninput="async e => await UpdateVendorAsync(i, e.Value?.ToString())" />
                </td>
                <td class="text-right">
                    <input type="number" step="0.01" class="input h-9 text-right" value="@row.Price" @oninput="async e => await UpdatePriceAsync(i, e.Value?.ToString())" />
                </td>
                <td>
                    <input class="input h-9 uppercase" maxlength="10" value="@row.Currency" @oninput="async e => await UpdateCurrencyAsync(i, e.Value?.ToString())" />
                </td>
                <td>
                    <input class="input h-9" value="@row.Url" @oninput="async e => await UpdateUrlAsync(i, e.Value?.ToString())" />
                </td>
                <td>
                    <select class="input h-9" value="@row.Availability" @onchange="async e => await UpdateAvailabilityAsync(i, e.Value?.ToString())">
                        <option value="in_stock">in_stock</option>
                        <option value="backorder">backorder</option>
                        <option value="discontinued">discontinued</option>
                        <option value="unknown">unknown</option>
                    </select>
                </td>
                <td class="text-right">
                    <button class="btn btn-ghost h-8 px-3" type="button" @onclick="() => RemoveRow(i)">
                        <span aria-hidden="true">Ã—</span>
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>
<div class="mt-3 flex justify-end">
    <button class="btn btn-soft h-8 px-3" type="button" @onclick="AddRow">+ add offering</button>
</div>

<datalist id="@_vendorListId">
    @foreach (var vendor in _vendors)
    {
        <option value="@vendor.Name"></option>
    }
</datalist>

@code {
    private readonly string _vendorListId = $"vendors-{Guid.NewGuid():N}";
    private readonly List<VendorResult> _vendors = new();

    [Parameter] public List<OfferingRow> Items { get; set; } = new();
    [Parameter] public EventCallback<List<OfferingRow>> ItemsChanged { get; set; }
    [Parameter] public EventCallback<List<OfferingRow>> OnChange { get; set; }

    public class OfferingRow
    {
        public string VendorName { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public string Currency { get; set; } = "USD";
        public string? Url { get; set; }
        public string Availability { get; set; } = "in_stock";
    }

    private record VendorResult(long VendorId, string Name);

    protected override void OnParametersSet()
    {
        Items ??= new();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var rows = await Http.GetFromJsonAsync<List<VendorResult>>("/api/admin/vendors?limit=200") ?? new();
            _vendors.Clear();
            _vendors.AddRange(rows);
        }
        catch
        {
            // swallow; the typeahead is optional
        }
    }

    private async Task PublishChangesAsync()
    {
        var snapshot = Items?.ToList() ?? new();
        Items = snapshot;
        if (ItemsChanged.HasDelegate)
        {
            await ItemsChanged.InvokeAsync(snapshot);
        }
        if (OnChange.HasDelegate)
        {
            await OnChange.InvokeAsync(snapshot);
        }
    }

    private bool EnsureIndex(int index) => index >= 0 && index < Items.Count;

    private async Task UpdateVendorAsync(int index, string? value)
    {
        if (!EnsureIndex(index))
            return;

        Items[index].VendorName = value?.Trim() ?? string.Empty;
        await PublishChangesAsync();
    }

    private async Task UpdatePriceAsync(int index, string? value)
    {
        if (!EnsureIndex(index))
            return;

        if (decimal.TryParse(value, NumberStyles.Number, CultureInfo.InvariantCulture, out var parsed))
        {
            Items[index].Price = parsed;
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            Items[index].Price = 0m;
        }

        await PublishChangesAsync();
    }

    private async Task UpdateCurrencyAsync(int index, string? value)
    {
        if (!EnsureIndex(index))
            return;

        Items[index].Currency = string.IsNullOrWhiteSpace(value) ? Items[index].Currency : value!.Trim().ToUpperInvariant();
        await PublishChangesAsync();
    }

    private async Task UpdateUrlAsync(int index, string? value)
    {
        if (!EnsureIndex(index))
            return;

        Items[index].Url = string.IsNullOrWhiteSpace(value) ? null : value!.Trim();
        await PublishChangesAsync();
    }

    private async Task UpdateAvailabilityAsync(int index, string? value)
    {
        if (!EnsureIndex(index))
            return;

        Items[index].Availability = string.IsNullOrWhiteSpace(value) ? Items[index].Availability : value!.Trim();
        await PublishChangesAsync();
    }

    private async Task AddRow()
    {
        Items.Add(new OfferingRow());
        await PublishChangesAsync();
    }

    private async Task RemoveRow(int index)
    {
        if (index < 0 || index >= Items.Count)
            return;

        Items.RemoveAt(index);
        await PublishChangesAsync();
    }
}
