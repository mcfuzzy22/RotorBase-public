@page "/admin/engine-attrs"
@rendermode InteractiveServer
@using System.Net.Http.Json
@using System.Text.Json
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject UserSession Session
@inject IJSRuntime JS

<h1 class="text-2xl font-semibold tracking-tight mb-4">Admin · Engine Attribute Definitions</h1>

@if (!Session.IsSignedIn)
{
    <div role="alert" class="rounded-md border border-blue-200 bg-blue-50 text-blue-800 px-3 py-2 text-sm">Sign in to view admin tools.</div>
}
else if (!Session.IsAdmin)
{
    <div role="alert" class="rounded-md border border-amber-200 bg-amber-50 text-amber-800 px-3 py-2 text-sm">You need admin access to manage engine attributes.</div>
}
else
{
    <div class="rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="p-4">
            <div class="flex flex-wrap items-center gap-2 mb-3">
                <input class="w-full sm:w-auto sm:max-w-[240px] rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Search code or name…" @bind="Q" @bind:event="oninput" />
                <button class="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50" @onclick="Load" disabled="@Loading">Search</button>
                <button class="inline-flex items-center rounded-md border border-emerald-300 bg-emerald-50 px-3 py-2 text-sm font-medium text-emerald-700 hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:opacity-50" @onclick="NewDefinition" disabled="@Saving">New</button>
            </div>

            @if (!string.IsNullOrEmpty(Error))
            {
                <div role="alert" class="mb-2 rounded-md border border-amber-200 bg-amber-50 text-amber-800 px-3 py-2 text-sm">@Error</div>
            }
            @if (!string.IsNullOrEmpty(Info))
            {
                <div role="alert" class="mb-2 rounded-md border border-emerald-200 bg-emerald-50 text-emerald-800 px-3 py-2 text-sm">@Info</div>
            }

            <div class="overflow-auto rounded-lg border border-gray-200">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-[18%] px-3 py-2 text-left font-semibold text-gray-700">Code</th>
                            <th class="w-[26%] px-3 py-2 text-left font-semibold text-gray-700">Name</th>
                            <th class="w-[18%] px-3 py-2 text-left font-semibold text-gray-700">Type</th>
                            <th class="w-[18%] px-3 py-2 text-left font-semibold text-gray-700">Unit</th>
                            <th class="w-[20%] px-3 py-2 text-right font-semibold text-gray-700"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        @if (Loading)
                        {
                            <tr>
                                <td colspan="5" class="px-3 py-6 text-center text-gray-500">Loading…</td>
                            </tr>
                        }
                        else if (Rows.Count == 0)
                        {
                            <tr>
                                <td colspan="5" class="px-3 py-6 text-center text-gray-500">No attribute definitions yet.</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var row in Rows)
                            {
                                <tr>
                                    <td class="px-3 py-2 font-mono text-[13px]">@row.code</td>
                                    <td class="px-3 py-2">
                                        <input class="w-full rounded-md border border-gray-300 px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" @bind="row.name" />
                                    </td>
                                    <td class="px-3 py-2">
                                        <select class="w-full rounded-md border border-gray-300 bg-white px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" @bind="row.data_type">
                                            <option value="int">int</option>
                                            <option value="decimal">decimal</option>
                                            <option value="bool">bool</option>
                                            <option value="text">text</option>
                                        </select>
                                    </td>
                                    <td class="px-3 py-2">
                                        <input class="w-full rounded-md border border-gray-300 px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" @bind="row.unit" />
                                    </td>
                                    <td class="px-3 py-2 text-right">
                                        <button class="mr-2 inline-flex items-center rounded-md bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50" @onclick="() => Save(row)" disabled="@Saving">Save</button>
                                        <button class="inline-flex items-center rounded-md border border-red-300 bg-white px-3 py-1.5 text-xs font-semibold text-red-700 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50" @onclick="() => Delete(row.engine_attr_id)" disabled="@Saving">Delete</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {
    // C# code-behind unchanged; markup-only Tailwind conversion
    record AttrRow
    {
        [JsonPropertyName("engine_attr_id")] public long engine_attr_id { get; set; }
        [JsonPropertyName("code")] public string code { get; set; } = string.Empty;
        [JsonPropertyName("name")] public string name { get; set; } = string.Empty;
        [JsonPropertyName("data_type")] public string data_type { get; set; } = "int";
        [JsonPropertyName("unit")] public string? unit { get; set; }
    }

    string Q { get; set; } = string.Empty;
    bool Loading;
    bool Saving;
    string? Error;
    string? Info;
    List<AttrRow> Rows { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await Session.HydrateAsync();
        if (Session.IsAdmin)
        {
            await Load();
        }
    }

    async Task Load()
    {
        if (!Session.IsAdmin) return;
        Loading = true;
        Error = null;
        Info = null;
        StateHasChanged();

        try
        {
            var url = string.IsNullOrWhiteSpace(Q)
                ? "/api/admin/engine-attrs"
                : $"/api/admin/engine-attrs?q={Uri.EscapeDataString(Q)}";
            Rows = await Http.GetFromJsonAsync<PayloadWrapper>(url) is { rows: not null } payload
                ? payload.rows
                : new List<AttrRow>();
        }
        catch (Exception ex)
        {
            Error = $"Failed to load attributes: {ex.Message}";
            Rows = new List<AttrRow>();
        }
        finally
        {
            Loading = false;
            StateHasChanged();
        }
    }

    async Task NewDefinition()
    {
        if (!Session.IsAdmin || Saving) return;
        var code = (await PromptAsync("New attribute code (e.g., primary_injector_cc)"))?.Trim();
        if (string.IsNullOrWhiteSpace(code))
        {
            return;
        }

        try
        {
            Saving = true;
            Error = null;
            Info = null;
            StateHasChanged();

            var resp = await Http.PostAsJsonAsync("/api/admin/engine-attrs", new
            {
                code = code.ToLowerInvariant(),
                name = code,
                data_type = "int",
                unit = string.Empty
            });

            if (!resp.IsSuccessStatusCode)
            {
                Error = await ExtractErrorAsync(resp);
                return;
            }

            Info = "Created.";
            await Load();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            Saving = false;
            StateHasChanged();
        }
    }

    async Task Save(AttrRow row)
    {
        if (!Session.IsAdmin || Saving) return;
        try
        {
            Saving = true;
            Error = null;
            Info = null;
            StateHasChanged();

            var resp = await Http.PatchAsJsonAsync($"/api/admin/engine-attrs/{row.engine_attr_id}", new
            {
                name = row.name,
                data_type = row.data_type,
                unit = row.unit
            });

            if (!resp.IsSuccessStatusCode)
            {
                Error = await ExtractErrorAsync(resp);
                return;
            }

            Info = "Saved.";
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            Saving = false;
            StateHasChanged();
        }
    }

    async Task Delete(long id)
    {
        if (!Session.IsAdmin || Saving) return;
        try
        {
            Saving = true;
            Error = null;
            Info = null;
            StateHasChanged();

            var resp = await Http.DeleteAsync($"/api/admin/engine-attrs/{id}");
            if (!resp.IsSuccessStatusCode)
            {
                Error = await ExtractErrorAsync(resp);
                return;
            }

            Info = "Deleted.";
            Rows.RemoveAll(r => r.engine_attr_id == id);
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            Saving = false;
            StateHasChanged();
        }
    }

    async Task<string?> PromptAsync(string label)
    {
        try
        {
            return await JS.InvokeAsync<string?>("prompt", label);
        }
        catch
        {
            return null;
        }
    }

    static async Task<string> ExtractErrorAsync(HttpResponseMessage response)
    {
        var body = await response.Content.ReadAsStringAsync();
        if (string.IsNullOrWhiteSpace(body))
        {
            return $"Request failed ({response.StatusCode}).";
        }

        try
        {
            using var doc = JsonDocument.Parse(body);
            if (doc.RootElement.ValueKind == JsonValueKind.Object)
            {
                if (doc.RootElement.TryGetProperty("message", out var message) && message.ValueKind == JsonValueKind.String)
                {
                    return message.GetString() ?? body;
                }
                if (doc.RootElement.TryGetProperty("error", out var error) && error.ValueKind == JsonValueKind.String)
                {
                    return error.GetString() ?? body;
                }
            }
        }
        catch (JsonException)
        {
        }

        return body;
    }

    class PayloadWrapper
    {
        [JsonPropertyName("rows")] public List<AttrRow> rows { get; set; } = new();
        [JsonPropertyName("total")] public int total { get; set; }
        [JsonPropertyName("page")] public int page { get; set; }
        [JsonPropertyName("pageSize")] public int pageSize { get; set; }
    }
}
