@page "/account/plan" 
@rendermode InteractiveServer
@using System.Net
@using System.Net.Http
@using System.Net.Http.Json
@using System.Text.Json.Serialization
@using System.Linq
@using System.Globalization
@using Microsoft.AspNetCore.WebUtilities
@using RotorBase
@inject HttpClient Http
@inject UserSession Session
@inject NavigationManager Nav
@implements IDisposable

<h1 class="mb-3 text-2xl font-semibold">Plan &amp; Usage</h1>

@if (!Session.IsSignedIn)
{
    <div class="rounded-md border border-sky-200 bg-sky-50 px-4 py-2 text-sm text-sky-800" role="alert">
        Sign in to manage your plan.
    </div>
}
else if (_loading)
{
    <div class="flex items-center gap-2 text-gray-700">
        <div class="h-4 w-4 animate-spin rounded-full border-2 border-indigo-600 border-t-transparent" aria-hidden="true"></div>
        <span class="text-sm">Loading plan details…</span>
    </div>
}
else if (!string.IsNullOrEmpty(_error))
{
    <div class="rounded-md border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700" role="alert">@_error</div>
}
else if (_current is null || _usage is null)
{
    <div class="rounded-md border border-amber-200 bg-amber-50 px-4 py-2 text-sm text-amber-800" role="alert">
        Unable to load plan data.
    </div>
}
else
{
    if (!Session.EmailVerified)
    {
        <div class="mb-4 flex flex-col items-start gap-3 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-amber-900 md:flex-row md:items-center">
            <div class="grow">
                <div class="font-semibold">Verify your email to unlock alerts.</div>
                <div class="text-xs text-amber-800">Price alerts and notifications only go to verified addresses.</div>
                @if (!string.IsNullOrEmpty(_resendSuccess))
                {
                    <div class="mt-1 text-xs text-emerald-700">@_resendSuccess</div>
                }
                else if (!string.IsNullOrEmpty(_resendError))
                {
                    <div class="mt-1 text-xs text-red-700">@_resendError</div>
                }
            </div>
            <div class="md:ms-auto">
                <button class="inline-flex items-center rounded-md border border-indigo-300 px-3 py-1.5 text-xs font-medium text-indigo-700 hover:bg-indigo-50 disabled:cursor-not-allowed disabled:opacity-60"
                        @onclick="ResendVerificationAsync" disabled="@_resendingVerification">
                    @(_resendingVerification ? "Sending…" : "Resend email")
                </button>
            </div>
        </div>
    }

    if (!string.IsNullOrEmpty(_flashMessage))
    {
        <div class="@_flashCss" role="alert">@_flashMessage</div>
    }

    <!-- Email opt-in card -->
    <div class="mb-4 rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="p-4">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <div class="text-xs uppercase tracking-wide text-gray-500">Email Updates</div>
                    <div class="font-semibold text-gray-900">Guides &amp; price alerts</div>
                    <p class="m-0 text-sm text-gray-500">Get weekly digests with new guides, price drops, and featured community builds.</p>
                </div>

                <!-- Tailwind switch -->
                <label class="relative inline-flex cursor-pointer items-center">
                    <input type="checkbox" class="peer sr-only"
                           checked="@_emailOptIn"
                           @onchange="OnOptInChanged"
                           disabled="@_updatingOptIn" />
                    <span class="h-6 w-11 rounded-full bg-gray-300 transition peer-checked:bg-indigo-600 peer-disabled:opacity-60"></span>
                    <span class="absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white shadow transition peer-checked:translate-x-5"></span>
                </label>
            </div>

            @if (!string.IsNullOrEmpty(_optInError))
            {
                <div class="mt-2 text-xs text-red-700">@_optInError</div>
            }
            else if (!string.IsNullOrEmpty(_optInSuccess))
            {
                <div class="mt-2 text-xs text-emerald-700">@_optInSuccess</div>
            }
        </div>
    </div>

    <!-- Current plan card -->
    <div class="mb-4 rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="flex flex-wrap items-center justify-between gap-3 p-4">
            <div>
                <div class="text-xs uppercase tracking-wide text-gray-500">Current Plan</div>
                <div class="text-lg font-semibold text-gray-900">@_current.plan_name (@_current.plan_code)</div>
            </div>

            <div class="text-sm text-gray-600">
                Active builds: <strong>@_usage.active_builds</strong> / @_current.max_active_builds
                <span class="mx-2">·</span>
                Total builds: <strong>@_usage.total_builds</strong> / @_current.max_total_builds
            </div>

            @if (IsCurrentPlanPaid)
            {
                <div class="flex gap-2">
                    <button class="inline-flex items-center rounded-md border border-indigo-300 px-3 py-1.5 text-xs font-medium text-indigo-700 hover:bg-indigo-50 disabled:cursor-not-allowed disabled:opacity-60"
                            disabled="@_portalLoading"
                            @onclick="OpenBillingPortalAsync">
                        @(_portalLoading ? "Opening portal..." : "Manage subscription")
                    </button>
                    <button class="inline-flex items-center rounded-md border border-red-300 px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-60"
                            disabled="@_cancelLoading"
                            @onclick="CancelSubscriptionAsync">
                        @(_cancelLoading ? "Canceling..." : $"Cancel {CurrentPlanDisplayName}")
                    </button>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(_cancelMessage))
        {
            <div class="border-t border-gray-100 p-4 text-sm @( _cancelSuccess ? "text-emerald-700" : "text-amber-700")">
                @_cancelMessage
            </div>
        }
    </div>

    <h2 class="mb-3 text-lg font-semibold">Available Plans</h2>

    <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
        @foreach (var plan in _catalog)
        {
            var isCurrent = string.Equals(plan.plan_code, _current.plan_code, StringComparison.OrdinalIgnoreCase);
            var isPaid = plan.monthly_price > 0m;
            var disableSelection = IsCurrentPlanPaid && !isCurrent && plan.monthly_price <= 0m;
            var actionText = isCurrent ? "Current plan" : isPaid ? "Upgrade" : "Choose plan";
            var busyText = isPaid ? "Opening checkout..." : "Updating...";

            <div class="h-full rounded-xl border border-gray-200 bg-white shadow-sm">
                <div class="flex h-full flex-col p-4">
                    <div class="flex items-baseline justify-between">
                        <div class="font-semibold text-gray-900">@plan.plan_name</div>
                        <span class="inline-flex items-center rounded-md bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-700">@plan.plan_code</span>
                    </div>

                    <div class="mt-2">
                        <span class="text-3xl font-semibold text-gray-900">@plan.monthly_price.ToString("C")</span>
                        <span class="text-sm text-gray-500">/mo</span>
                    </div>

                    <div class="mt-3 text-sm text-gray-600">
                        Active builds: @plan.max_active_builds<br />
                        Total builds: @plan.max_total_builds
                    </div>

                    <div class="mt-auto pt-3">
                        <button class="w-full rounded-md px-3 py-2 text-xs font-medium text-white disabled:cursor-not-allowed disabled:opacity-60
                                       @(isCurrent ? "border border-gray-300 bg-white text-gray-700 hover:bg-gray-50" : "bg-indigo-600 hover:bg-indigo-700")"
                                disabled="@(isCurrent || _changing || disableSelection)"
                                @onclick="() => OnPlanSelected(plan)">
                            @(_changing && !isCurrent ? busyText : actionText)
                        </button>

                        @if (disableSelection)
                        {
                            <div class="mt-2 text-xs text-gray-500">@CancelToFreeMessage</div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {

    class PlanResponse
    {
        [JsonPropertyName("current")] public CurrentPlan? Current { get; set; }
        [JsonPropertyName("usage")] public UsageInfo? Usage { get; set; }
        [JsonPropertyName("catalog")] public List<PlanCatalog> Catalog { get; set; } = new();
    }

    class CurrentPlan
    {
        [JsonPropertyName("user_id")] public long user_id { get; set; }
        [JsonPropertyName("plan_code")] public string plan_code { get; set; } = string.Empty;
        [JsonPropertyName("plan_name")] public string plan_name { get; set; } = string.Empty;
        [JsonPropertyName("max_active_builds")] public int max_active_builds { get; set; }
        [JsonPropertyName("max_total_builds")] public int max_total_builds { get; set; }
    }

    class UsageInfo
    {
        [JsonPropertyName("active_builds")] public int active_builds { get; set; }
        [JsonPropertyName("total_builds")] public int total_builds { get; set; }
    }

    class PlanCatalog
    {
        [JsonPropertyName("plan_code")] public string plan_code { get; set; } = string.Empty;
        [JsonPropertyName("plan_name")] public string plan_name { get; set; } = string.Empty;
        [JsonPropertyName("monthly_price")] public decimal monthly_price { get; set; }
        [JsonPropertyName("currency")] public string currency { get; set; } = string.Empty;
        [JsonPropertyName("max_active_builds")] public int? max_active_builds { get; set; }
        [JsonPropertyName("max_total_builds")] public int? max_total_builds { get; set; }
    }

    class CheckoutResponse
    {
        [JsonPropertyName("url")] public string? Url { get; set; }
    }

    class CancelResponse
    {
        [JsonPropertyName("status")] public string? Status { get; set; }
        [JsonPropertyName("cancel_at_period_end")] public bool CancelAtPeriodEnd { get; set; }
        [JsonPropertyName("current_period_end")] public DateTime? CurrentPeriodEnd { get; set; }
        [JsonPropertyName("cancel_at")] public DateTime? CancelAt { get; set; }
    }

    CurrentPlan? _current;
    UsageInfo? _usage;
    List<PlanCatalog> _catalog = new();
    bool _loading = true;
    bool _changing;
    bool _portalLoading;
    bool _cancelLoading;
    string? _error;

    // Tailwind alert classes (replacing Bootstrap)
    string? _flashMessage;
    string _flashCss = "mb-4 rounded-md border border-emerald-200 bg-emerald-50 px-4 py-2 text-sm text-emerald-800";

    bool _emailOptIn;
    bool _updatingOptIn;
    string? _optInError;
    string? _optInSuccess;
    string? _cancelMessage;
    bool _cancelSuccess;
    bool _resendingVerification;
    string? _resendSuccess;
    string? _resendError;

    protected override async Task OnInitializedAsync()
    {
        LoadFlashFromQuery();
        await LoadAsync();
    }

    protected override void OnInitialized()
    {
        Session.Changed += OnSessionChanged;
    }

    async Task LoadAsync()
    {
        await Session.HydrateAsync();
        if (!Session.IsSignedIn)
        {
            _loading = false;
            return;
        }

        _loading = true;
        _error = null;
        try
        {
            var response = await Http.GetFromJsonAsync<PlanResponse>("/api/me/plan");
            _current = response?.Current;
            _usage = response?.Usage;
            _catalog = response?.Catalog ?? new();
            _emailOptIn = Session.EmailOptIn;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
            _emailOptIn = Session.EmailOptIn;
            StateHasChanged();
        }
    }

    void LoadFlashFromQuery()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (string.IsNullOrEmpty(uri.Query))
            return;

        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("success", out var success) && success == "1")
        {
            _flashMessage = "Thanks! Your subscription is being activated.";
            _flashCss = "mb-4 rounded-md border border-emerald-200 bg-emerald-50 px-4 py-2 text-sm text-emerald-800";
        }
        else if (query.TryGetValue("canceled", out var canceled) && canceled == "1")
        {
            _flashMessage = "Checkout canceled.";
            _flashCss = "mb-4 rounded-md border border-amber-200 bg-amber-50 px-4 py-2 text-sm text-amber-800";
        }
        else if (query.TryGetValue("verify", out var verifyValue))
        {
            var code = verifyValue.ToString();
            switch (code)
            {
                case "ok":
                    _flashMessage = "Email verified. Alerts are ready to go.";
                    _flashCss = "mb-4 rounded-md border border-emerald-200 bg-emerald-50 px-4 py-2 text-sm text-emerald-800";
                    break;
                case "expired":
                    _flashMessage = "That verification link expired. Send yourself a fresh one.";
                    _flashCss = "mb-4 rounded-md border border-amber-200 bg-amber-50 px-4 py-2 text-sm text-amber-800";
                    break;
                case "invalid":
                    _flashMessage = "We couldn’t find that verification link. Send a new one.";
                    _flashCss = "mb-4 rounded-md border border-amber-200 bg-amber-50 px-4 py-2 text-sm text-amber-800";
                    break;
                case "error":
                    _flashMessage = "Verification failed. Please try again.";
                    _flashCss = "mb-4 rounded-md border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700";
                    break;
            }
        }
    }

    async Task ResendVerificationAsync()
    {
        if (_resendingVerification)
            return;

        _resendSuccess = null;
        _resendError = null;
        _resendingVerification = true;

        try
        {
            var resp = await Http.PostAsync("/api/auth/resend-verification", null);
            if (resp.IsSuccessStatusCode)
            {
                _resendSuccess = "Verification email sent. Check your inbox.";
            }
            else
            {
                ApiError? error = null;
                try { error = await resp.Content.ReadFromJsonAsync<ApiError>(); } catch { }
                _resendError = MapResendError(error?.Error, resp.StatusCode);
            }
        }
        catch (Exception ex)
        {
            _resendError = ex.Message;
        }
        finally
        {
            _resendingVerification = false;
            StateHasChanged();
        }
    }

    async Task OnPlanSelected(PlanCatalog plan)
    {
        if (_changing || plan is null)
            return;

        _error = null;
        _cancelMessage = null;
        _cancelSuccess = false;

        if (_current is not null && string.Equals(plan.plan_code, _current.plan_code, StringComparison.OrdinalIgnoreCase))
            return;

        if (plan.monthly_price > 0m)
        {
            await StartCheckoutAsync(plan.plan_code);
            return;
        }

        if (IsCurrentPlanPaid)
        {
            _error = CancelToFreeMessage;
            StateHasChanged();
            return;
        }

        await ChangePlan(plan.plan_code);
    }

    async Task ChangePlan(string planCode)
    {
        if (_changing || string.IsNullOrWhiteSpace(planCode)) return;
        _changing = true;
        _error = null;
        _cancelMessage = null;
        _cancelSuccess = false;
        try
        {
            var resp = await Http.PostAsJsonAsync("/api/me/plan", new UserPlanChangeRequest { PlanCode = planCode });
            if (!resp.IsSuccessStatusCode)
            {
                var detail = await resp.Content.ReadAsStringAsync();
                if (detail.Contains("upgrade_requires_checkout", StringComparison.OrdinalIgnoreCase))
                {
                    _error = "Please use the upgrade button to start checkout.";
                }
                else if (detail.Contains("paid_plan_requires_cancel", StringComparison.OrdinalIgnoreCase))
                {
                    _error = CancelToFreeMessage;
                }
                else
                {
                    _error = $"Plan change failed: {(int)resp.StatusCode} {resp.ReasonPhrase}. {detail}";
                }
            }
            else
            {
                await LoadAsync();
                await Session.RefreshLimitsAsync();
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _changing = false;
            StateHasChanged();
        }
    }

    async Task StartCheckoutAsync(string planCode)
    {
        if (string.IsNullOrWhiteSpace(planCode))
            return;

        _changing = true;
        _error = null;
        _cancelMessage = null;
        _cancelSuccess = false;
        try
        {
            var payload = new CheckoutSessionRequest { PlanCode = planCode.Trim() };
            var resp = await Http.PostAsJsonAsync("/api/billing/checkout", payload);
            if (!resp.IsSuccessStatusCode)
            {
                var detail = await resp.Content.ReadAsStringAsync();
                if (detail.Contains("plan_missing_stripe_price", StringComparison.OrdinalIgnoreCase))
                {
                    _error = "This plan is not ready for checkout yet. Please contact support.";
                }
                else if (detail.Contains("unknown_plan_code", StringComparison.OrdinalIgnoreCase))
                {
                    _error = "Plan is not recognized by billing. Refresh and try again.";
                }
                else
                {
                    _error = $"Unable to start checkout: {(int)resp.StatusCode} {resp.ReasonPhrase}. {detail}";
                }
                return;
            }

            var session = await resp.Content.ReadFromJsonAsync<CheckoutResponse>();
            var url = session?.Url;
            if (string.IsNullOrWhiteSpace(url))
            {
                _error = "Checkout URL was not provided.";
                return;
            }

            Nav.NavigateTo(url!, forceLoad: true);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _changing = false;
            StateHasChanged();
        }
    }

    async Task OnOptInChanged(ChangeEventArgs e)
    {
        if (_updatingOptIn) return;

        var newValue = e.Value switch
        {
            bool b => b,
            string s when bool.TryParse(s, out var parsed) => parsed,
            _ => false
        };

        if (newValue == _emailOptIn)
            return;

        var previous = _emailOptIn;
        _emailOptIn = newValue;
        _updatingOptIn = true;
        _optInError = null;
        _optInSuccess = null;

        try
        {
            using var request = new HttpRequestMessage(HttpMethod.Patch, "/api/me")
            {
                Content = JsonContent.Create(new UserProfileUpdateRequest { EmailOptIn = newValue })
            };

            var resp = await Http.SendAsync(request);
            if (resp.IsSuccessStatusCode)
            {
                _optInSuccess = "Preferences updated.";
                Session.UpdateEmailOptIn(newValue);
            }
            else
            {
                _emailOptIn = previous;
                var detail = await resp.Content.ReadAsStringAsync();
                _optInError = $"Failed to update: {(int)resp.StatusCode} {resp.ReasonPhrase}. {detail}";
            }
        }
        catch (Exception ex)
        {
            _emailOptIn = previous;
            _optInError = ex.Message;
        }
        finally
        {
            _updatingOptIn = false;
            StateHasChanged();
        }
    }

    bool IsCurrentPlanPaid =>
        _current is not null &&
        ((_catalog.FirstOrDefault(p => string.Equals(p.plan_code, _current.plan_code, StringComparison.OrdinalIgnoreCase))?.monthly_price) ?? 0m) > 0m;

    string CurrentPlanDisplayName =>
        !string.IsNullOrWhiteSpace(_current?.plan_name)
            ? _current!.plan_name
            : string.IsNullOrWhiteSpace(_current?.plan_code) ? "current plan" : _current!.plan_code;

    string CancelToFreeMessage => $"Cancel {CurrentPlanDisplayName} to return to Free.";

    async Task OpenBillingPortalAsync()
    {
        if (_portalLoading)
            return;

        _portalLoading = true;
        _error = null;
        _cancelMessage = null;
        _cancelSuccess = false;
        try
        {
            var resp = await Http.PostAsync("/api/billing/portal", null);
            if (!resp.IsSuccessStatusCode)
            {
                var detail = await resp.Content.ReadAsStringAsync();
                _error = $"Unable to open billing portal: {(int)resp.StatusCode} {resp.ReasonPhrase}. {detail}";
                return;
            }

            var portal = await resp.Content.ReadFromJsonAsync<CheckoutResponse>();
            var url = portal?.Url;
            if (string.IsNullOrWhiteSpace(url))
            {
                _error = "Billing portal URL was not provided.";
                return;
            }

            Nav.NavigateTo(url!, forceLoad: true);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _portalLoading = false;
            StateHasChanged();
        }
    }

    async Task CancelSubscriptionAsync()
    {
        if (_cancelLoading)
            return;

        _cancelLoading = true;
        _error = null;
        _cancelMessage = null;
        _cancelSuccess = false;
        try
        {
            var resp = await Http.PostAsync("/api/billing/cancel", null);
            if (!resp.IsSuccessStatusCode)
            {
                var detail = await resp.Content.ReadAsStringAsync();
                if (detail.Contains("no_active_subscription", StringComparison.OrdinalIgnoreCase))
                {
                    _error = "No active subscription to cancel.";
                }
                else
                {
                    _error = $"Unable to cancel subscription: {(int)resp.StatusCode} {resp.ReasonPhrase}. {detail}";
                }
                return;
            }

            var result = await resp.Content.ReadFromJsonAsync<CancelResponse>();
            var planLabel = CurrentPlanDisplayName;

            if (result?.CancelAtPeriodEnd == true)
            {
                DateTime? effective = result.CancelAt ?? result.CurrentPeriodEnd;
                var whenText = effective?.ToLocalTime().ToString("MMM d, yyyy h:mm tt", CultureInfo.CurrentCulture) ?? "the end of the current period";
                _cancelMessage = $"Your {planLabel} plan will remain active until {whenText}.";
                _cancelSuccess = true;
            }
            else
            {
                _cancelMessage = $"Cancellation requested for {planLabel}. Check your email for confirmation.";
                _cancelSuccess = true;
            }

            await LoadAsync();
            await Session.RefreshLimitsAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _cancelLoading = false;
            StateHasChanged();
        }
    }

    static string MapResendError(string? code, HttpStatusCode status)
        => code switch
        {
            "already_verified" => "Your email is already verified.",
            "too_soon" => "We just sent one—check your inbox in a few minutes.",
            "email_missing" => "Add an email address to your profile first.",
            "email_send_failed" => "We couldn’t send the verification email. Double-check SMTP settings and try again.",
            _ => status == HttpStatusCode.BadRequest
                ? "Unable to resend verification right now. Try again later."
                : $"Unable to resend verification (HTTP {(int)status})."
        };

    sealed class ApiError
    {
        [JsonPropertyName("error")] public string? Error { get; set; }
    }

    private void OnSessionChanged()
    {
        _emailOptIn = Session.EmailOptIn;
        StateHasChanged();
    }

    public void Dispose()
    {
        Session.Changed -= OnSessionChanged;
    }
}
