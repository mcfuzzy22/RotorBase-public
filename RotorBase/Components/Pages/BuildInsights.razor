@page "/builds/{BuildId:long}/insights"
@rendermode InteractiveServer
@using System.Globalization
@inject HttpClient Http

<h1 class="mb-4 text-2xl font-semibold">Build Insights</h1>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
  <div class="rounded-md border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700">@ErrorMessage</div>
}
else if (IsLoading)
{
  <div class="flex flex-col items-center justify-center gap-2 text-gray-500">
    <div class="h-5 w-5 animate-spin rounded-full border-2 border-indigo-600 border-t-transparent"></div>
    <div class="text-sm">Loading build data…</div>
  </div>
}
else if (Summary is null)
{
  <div class="rounded-md border border-amber-200 bg-amber-50 px-4 py-2 text-sm text-amber-800">No summary data available for this build.</div>
}
else
{
  <div class="mb-4">
    <h4 class="text-lg font-semibold">@(BuildInfo?.name ?? $"Build #{BuildId}")</h4>
    <div class="text-xs text-gray-500">Created @FormatDate(BuildInfo?.created_at) · Updated @FormatDate(BuildInfo?.updated_at)</div>
  </div>

  <!-- KPI row -->
  <div class="mb-4 grid gap-3 md:grid-cols-4">
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="text-xs uppercase tracking-wide text-gray-500">Completion</div>
      <div class="mt-1 text-3xl font-semibold">@FormatPercent(Summary.completion_pct)</div>
      <div class="mt-1 text-xs text-gray-500">@Summary.categories_complete of @Summary.categories_total categories</div>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="text-xs uppercase tracking-wide text-gray-500">Open Categories</div>
      <div class="mt-1 text-3xl font-semibold">@Summary.categories_incomplete</div>
      <div class="mt-1 text-xs text-gray-500">Includes formula-driven: @FormulaPendingCount</div>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="text-xs uppercase tracking-wide text-gray-500">Pieces Missing</div>
      <div class="mt-1 text-3xl font-semibold">@FormatDecimal(Summary.total_pieces_missing)</div>
      <div class="mt-1 text-xs text-gray-500">Across incomplete categories</div>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="text-xs uppercase tracking-wide text-gray-500">Est. Cost (Lowest)</div>
      <div class="mt-1 text-3xl font-semibold">@FormatCurrency(Summary.estimated_cost_lowest)</div>
      <div class="mt-1 text-xs text-gray-500">Based on best current offerings</div>
    </div>
  </div>

  <div class="grid gap-4 lg:grid-cols-12">
    <div class="lg:col-span-7">
      <div class="overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="border-b border-gray-100 bg-gray-50 px-4 py-2">
          <h5 class="m-0 text-sm font-semibold">Category Status</h5>
        </div>
        <div class="p-0">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-gray-50 text-xs uppercase text-gray-500">
              <tr>
                <th class="px-3 py-2">Category</th>
                <th class="px-3 py-2">Required</th>
                <th class="px-3 py-2">Supplied</th>
                <th class="px-3 py-2">Status</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              @if (Completion.Count == 0)
              {
                <tr>
                  <td colspan="4" class="px-3 py-6 text-center text-sm text-gray-500">No category rows found.</td>
                </tr>
              }
              else
              {
                @foreach (var row in Completion)
                {
                  var statusClass = row.status switch
                  {
                    "complete"           => "inline-flex items-center rounded-md bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-800",
                    "incomplete"         => "inline-flex items-center rounded-md bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800",
                    "needs_formula_eval" => "inline-flex items-center rounded-md bg-sky-100 px-2 py-0.5 text-xs font-medium text-sky-800",
                    _                    => "inline-flex items-center rounded-md bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-700"
                  };

                  <tr>
                    <td class="px-3 py-2">
                      <div class="font-medium">@row.category_name</div>
                      <div class="text-xs text-gray-500">Mode: @row.req_mode</div>
                    </td>
                    <td class="px-3 py-2">@FormatDecimal(row.required_qty)</td>
                    <td class="px-3 py-2">@FormatDecimal(row.pieces_supplied)</td>
                    <td class="px-3 py-2"><span class="@statusClass">@row.status</span></td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="lg:col-span-5">
      <div class="mb-4 overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="border-b border-gray-100 bg-gray-50 px-4 py-2">
          <h5 class="m-0 text-sm font-semibold">Missing & Formula Categories</h5>
        </div>
        <div class="p-4 text-sm">
          @if (MissingCategories.Count == 0 && FormulaCategories.Count == 0)
          {
            <p class="m-0 text-gray-500">All categories are satisfied.</p>
          }
          else
          {
            @if (MissingCategories.Count > 0)
            {
              <div class="mb-3">
                <div class="mb-1 font-semibold">Incomplete</div>
                <ul class="list-disc pl-5">
                  @foreach (var item in MissingCategories)
                  {
                    <li class="mb-1">
                      <span class="font-medium">@item.category_name</span>
                      <span class="text-gray-500"> (@FormatDecimal(item.pieces_missing) missing)</span>
                    </li>
                  }
                </ul>
              </div>
            }
            @if (FormulaCategories.Count > 0)
            {
              <div>
                <div class="mb-1 font-semibold">Needs Formula Evaluation</div>
                <ul class="list-disc pl-5">
                  @foreach (var item in FormulaCategories)
                  {
                    <li class="mb-1">
                      <span class="font-medium">@item.category_name</span>
                      <span class="text-gray-500"> (@item.formula)</span>
                    </li>
                  }
                </ul>
              </div>
            }
          }
        </div>
      </div>

      <div class="overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="border-b border-gray-100 bg-gray-50 px-4 py-2">
          <h5 class="m-0 text-sm font-semibold">Brand Spend Mix</h5>
        </div>
        <div class="p-0">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-gray-50 text-xs uppercase text-gray-500">
              <tr>
                <th class="px-3 py-2">Brand</th>
                <th class="px-3 py-2 text-right">Qty</th>
                <th class="px-3 py-2 text-right">Est. Spend</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              @if (BrandMix.Count == 0)
              {
                <tr>
                  <td colspan="3" class="px-3 py-6 text-center text-sm text-gray-500">No pricing data available.</td>
                </tr>
              }
              else
              {
                @foreach (var brand in BrandMix)
                {
                  <tr>
                    <td class="px-3 py-2">@brand.brand_name</td>
                    <td class="px-3 py-2 text-right">@FormatDecimal(brand.total_qty)</td>
                    <td class="px-3 py-2 text-right">@FormatCurrency(brand.est_spend)</td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
}

@code {
    [Parameter] public long BuildId { get; set; }

    record SummaryDto(long build_id, int categories_total, int categories_complete, int categories_incomplete, decimal? completion_pct, decimal? total_pieces_missing, decimal? estimated_cost_lowest);
    record BuildInfoDto(long build_id, long engine_family_id, long? tree_id, string name, DateTime created_at, DateTime updated_at);
    class CompletionRow
    {
        public long build_id { get; set; }
        public long category_id { get; set; }
        public string? category_name { get; set; }
        public string? req_mode { get; set; }
        public string? requirement_type { get; set; }
        public string? formula { get; set; }
        public decimal? required_qty { get; set; }
        public decimal? pieces_supplied { get; set; }
        public decimal? pieces_missing { get; set; }
        public string status { get; set; } = "unknown";
    }
    record BrandMixDto(long build_id, string brand_name, decimal? total_qty, decimal? est_spend);

    SummaryDto? Summary;
    BuildInfoDto? BuildInfo;
    List<CompletionRow> Completion = new();
    List<CompletionRow> MissingCategories = new();
    List<CompletionRow> FormulaCategories = new();
    List<BrandMixDto> BrandMix = new();
    bool IsLoading = true;
    string? ErrorMessage;
    int FormulaPendingCount => FormulaCategories.Count;

    protected override async Task OnParametersSetAsync()
    {
        await LoadDataAsync();
    }

    async Task LoadDataAsync()
    {
        ErrorMessage = null;
        IsLoading = true;
        try
        {
            BuildInfo = await Http.GetFromJsonAsync<BuildInfoDto>($"/api/builds/{BuildId}");
            Summary = await Http.GetFromJsonAsync<SummaryDto>($"/api/builds/{BuildId}/summary");
            Completion = await Http.GetFromJsonAsync<List<CompletionRow>>($"/api/builds/{BuildId}/completion") ?? new();
            BrandMix = await Http.GetFromJsonAsync<List<BrandMixDto>>($"/api/builds/{BuildId}/brand-mix") ?? new();

            MissingCategories = Completion.Where(c => string.Equals(c.status, "incomplete", StringComparison.OrdinalIgnoreCase)).OrderByDescending(c => c.pieces_missing ?? 0).ToList();
            FormulaCategories = Completion.Where(c => string.Equals(c.status, "needs_formula_eval", StringComparison.OrdinalIgnoreCase)).ToList();
        }
        catch (HttpRequestException ex)
        {
            ErrorMessage = $"Failed to load build data: {ex.Message}";
        }
        catch (NotSupportedException ex)
        {
            ErrorMessage = $"Unsupported response format: {ex.Message}";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    static string FormatPercent(decimal? value)
        => value.HasValue ? FormattableString.Invariant($"{value.Value:0.0}%") : "—";

    static string FormatDecimal(decimal? value)
        => value.HasValue ? FormattableString.Invariant($"{value.Value:0.##}") : "—";

    static string FormatCurrency(decimal? value)
        => value.HasValue ? FormattableString.Invariant($"${value.Value:0.00}") : "—";

    static string FormatDate(DateTime? value)
        => value.HasValue ? value.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm", CultureInfo.InvariantCulture) : "—";
}
