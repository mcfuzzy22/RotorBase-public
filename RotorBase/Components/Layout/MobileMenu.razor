@rendermode InteractiveServer
@using RotorBase.Components.Layout
@inject NavigationManager Nav
@implements IDisposable

<div class="md:hidden">
    <button type="button"
            class="inline-flex h-10 items-center gap-2 rounded-md border border-border/60 bg-surface px-3 text-sm font-semibold text-foreground shadow-sm"
            aria-label="Open navigation menu"
            @onclick="Toggle">
        <svg class="h-5 w-5" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8" fill="none" stroke-linecap="round">
            <path d="M4 7h16M4 12h16M4 17h16"></path>
        </svg>
        <span>Menu</span>
    </button>

    @if (_open)
    {
        <div class="fixed inset-0 z-50 md:hidden">
            <button class="absolute inset-0 bg-black/50" aria-label="Close navigation menu" @onclick="Close"></button>
            <div class="absolute inset-y-0 right-0 flex w-full max-w-xs flex-col gap-6 overflow-y-auto bg-surface p-5 shadow-2xl ring-1 ring-border/60">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-wide text-foreground/60">Menu</p>
                        <p class="text-lg font-semibold text-foreground">BoostedRotary.com</p>
                    </div>
                    <button type="button" class="rounded-md border border-border/60 p-2 text-foreground" @onclick="Close" aria-label="Close">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round">
                            <path d="m6 6 12 12M6 18 18 6"></path>
                        </svg>
                    </button>
                </div>

                <nav class="space-y-2 text-base font-medium text-foreground">
                    @foreach (var link in _links)
                    {
                        <NavLink href="@link.Href" class="flex items-center justify-between rounded-lg border border-transparent px-3 py-2 hover:border-border/80" ActiveClass="bg-primary/10 text-primary" @onclick="Close">
                            <span>@link.Label</span>
                            <svg class="h-4 w-4 text-foreground/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                                <path d="m9 6 6 6-6 6"></path>
                            </svg>
                        </NavLink>
                    }
                </nav>

                <section class="space-y-3">
                    <p class="text-xs uppercase tracking-wide text-foreground/60">Account</p>
                    <AuthControls />
                </section>
            </div>
        </div>
    }
</div>

@code {
    private bool _open;

    private readonly (string Label, string Href)[] _links = new[]
    {
        ("Home", "/"),
        ("Builder", "/builder"),
        ("Shop", "/shop"),
        ("Builds", "/builds"),
        ("Bundles", "/bundles"),
        ("Community", "/builds/gallery"),
    };

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    private void Toggle() => _open = !_open;

    private void Close()
    {
        if (_open)
        {
            _open = false;
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs args)
    {
        if (_open)
        {
            _open = false;
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }
}
