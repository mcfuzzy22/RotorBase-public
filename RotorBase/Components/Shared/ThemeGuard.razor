@inject ThemeService Theme
@inject NavigationManager Nav
@implements IDisposable

@code {
    private bool _registered;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await ApplyAsync();
        if (firstRender && !_registered)
        {
            Nav.LocationChanged += OnLocationChanged;
            _registered = true;
        }
    }

    private async Task ApplyAsync()
    {
        try
        {
            await Theme.ApplyAsync();
        }
        catch
        {
            // Ignore; script may not be ready yet.
        }
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs args)
    {
        await ApplyAsync();
    }

    public void Dispose()
    {
        if (_registered)
        {
            Nav.LocationChanged -= OnLocationChanged;
        }
    }
}
