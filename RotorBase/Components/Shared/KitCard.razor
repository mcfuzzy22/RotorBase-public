@using System.Globalization
@using System.Text.Json.Serialization
@inject HttpClient Http

<div class="group/card card h-full p-3 flex flex-col overflow-hidden transition ring-1 ring-border/60 hover:ring-primary/25 hover:shadow-lg focus-within:shadow-lg">
  <div class="flex items-start gap-3">
    <div class="relative">
      <img src="@ImageSource"
           alt="@Name"
           decoding="async" loading="lazy" fetchpriority="low"
           class="w-[72px] h-[72px] rounded-lg object-cover bg-muted ring-1 ring-border/60"
           onerror="this.onerror=null;this.src='@PlaceholderImageDataUri';" />
      <span class="absolute -right-1 -top-1 badge bg-secondary/15 text-secondary ring-secondary/25">Kit</span>
    </div>

    <div class="min-w-0 flex-1">
      <div class="text-[11px] uppercase tracking-wide text-foreground/60">@Brand</div>
      <a class="block truncate text-sm font-semibold text-foreground hover:text-primary transition"
         href="@DetailUrl" title="@Name">@Name</a>
      <div class="truncate text-[12px] text-foreground/55">@Sku</div>

      <div class="mt-1 flex flex-wrap gap-1">
        @if (FitsEngine && !string.IsNullOrWhiteSpace(EngineCode))
        {
          <span class="badge bg-success/10 text-success ring-success/20">Fits @EngineCode</span>
        }
      </div>
    </div>
  </div>

  <div class="mt-3">
    @if (BestPrice is not null)
    {
      <div class="text-lg font-semibold tabular-nums">@BestPrice.Value.ToString("C", CultureInfo.CurrentCulture)</div>
    }
    else
    {
      <span class="badge bg-muted text-foreground/70 ring-border/60">Request quote</span>
    }
  </div>

  <div class="mt-3">
    <button class="btn btn-ghost h-8 px-3"
            @onclick="TogglePreview" aria-expanded="@PreviewOpen">
      @PreviewToggleText
    </button>

    @if (PreviewOpen)
    {
      @if (PreviewBusy)
      {
        <div class="mt-2 text-xs text-foreground/70">Loading…</div>
      }
      else if (!string.IsNullOrEmpty(PreviewError))
      {
        <div class="mt-2 text-xs text-danger">@PreviewError</div>
      }
      else if (Bom.Count == 0)
      {
        <div class="mt-2 text-xs text-foreground/70">No components available.</div>
      }
      else
      {
        <ul class="mt-2 text-xs space-y-1">
          @foreach (var line in Bom)
          {
            <li class="flex flex-wrap gap-1">
              <span class="text-foreground/60 tabular-nums">@line.Qty.ToString("G", CultureInfo.CurrentCulture)×</span>
              <strong>@line.Sku</strong>
              <span class="text-foreground/60">— @line.Name</span>
            </li>
          }
        </ul>
      }
    }
  </div>

  <div class="mt-auto pt-3 flex flex-wrap gap-2">
    <a class="btn btn-ghost h-8 px-3" href="@DetailUrl" aria-label="View @Name">View</a>

    <button class="btn btn-soft h-8 px-3"
            disabled="@AddBusy" aria-busy="@AddBusy"
            @onclick="HandleAddToBuildAsync">
      @(AddBusy ? "Opening…" : "Add to build")
    </button>

    @if (BestPrice is not null)
    {
      <a class="btn btn-primary h-8 px-3"
         href="@BuyHref" target="_blank" rel="noopener noreferrer">
        Buy
      </a>
    }

    <div class="relative">
      <button class="btn btn-ghost h-8 px-3"
              disabled="@string.IsNullOrWhiteSpace(Sku) || !OnCompare.HasDelegate"
              @onclick="TriggerCompareAsync" aria-label="Compare @Name">
        Compare
      </button>
      @if (cmpPulse)
      {
        <span class="absolute -top-1 -right-1">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-secondary opacity-60"></span>
            <span class="relative inline-flex h-2 w-2 rounded-full bg-secondary"></span>
          </span>
        </span>
      }
    </div>
  </div>

  @if (!string.IsNullOrEmpty(InlineError))
  {
    <div class="mt-2 text-xs text-danger">@InlineError</div>
  }
</div>

@code {
  private const string PlaceholderImageDataUri =
    "data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2772%27 height=%2772%27 viewBox=%270 0 72 72%27%3E%3Crect width=%2772%27 height=%2772%27 fill=%27%23f1f3f5%27/%3E%3Cpath d=%27M18 50l12-14 9 10 9-12 12 16H18z%27 fill=%27%23ced4da%27/%3E%3Ccircle cx=%2726%27 cy=%2726%27 r=%276%27 fill=%27%23ced4da%27/%3E%3C/svg%3E";

  [Parameter] public long PartId { get; set; }
  [Parameter] public string Sku { get; set; } = string.Empty;
  [Parameter] public string Name { get; set; } = string.Empty;
  [Parameter] public string Brand { get; set; } = string.Empty;
  [Parameter] public string? ImageUrl { get; set; }
  [Parameter] public decimal? BestPrice { get; set; }
  [Parameter] public bool FitsEngine { get; set; }
  [Parameter] public string? EngineCode { get; set; }
  [Parameter] public EventCallback<ShopCardAddRequest> AddToBuildRequested { get; set; }
  [Parameter] public EventCallback<string> OnCompare { get; set; }

  private bool AddBusy;
  private bool PreviewOpen;
  private bool PreviewBusy;
  private string? PreviewError;
  private string? InlineError;
  private readonly List<BomLine> Bom = new();
  private bool cmpPulse;

  private string ImageSource => string.IsNullOrWhiteSpace(ImageUrl) ? PlaceholderImageDataUri : ImageUrl!;
  private string DetailUrl => $"/bundles/{PartId}";
  private string BuyHref => $"/shop/go?partId={PartId}";
  private string PreviewToggleText => PreviewOpen ? "Hide contents" : "Preview contents";

  private async Task HandleAddToBuildAsync()
  {
    InlineError = null;
    if (!AddToBuildRequested.HasDelegate)
    {
      InlineError = "Build actions are unavailable.";
      return;
    }

    AddBusy = true;
    try
    {
      var sku = string.IsNullOrWhiteSpace(Sku) ? null : Sku;
      await AddToBuildRequested.InvokeAsync(new ShopCardAddRequest(PartId, sku));
    }
    finally { AddBusy = false; }
  }

  private async Task TriggerCompareAsync()
  {
    InlineError = null;
    if (!OnCompare.HasDelegate || string.IsNullOrWhiteSpace(Sku)) return;

    cmpPulse = true; StateHasChanged();
    await OnCompare.InvokeAsync(Sku);
    await Task.Delay(500);
    cmpPulse = false; StateHasChanged();
  }

  private async Task TogglePreview()
  {
    PreviewOpen = !PreviewOpen;
    if (!PreviewOpen || Bom.Count > 0 || PreviewBusy) return;
    await LoadComponentsAsync();
  }

  private async Task LoadComponentsAsync()
  {
    PreviewBusy = true; PreviewError = null;
    try
    {
      var key = !string.IsNullOrWhiteSpace(Sku) ? Sku : PartId.ToString(CultureInfo.InvariantCulture);
      var result = await Http.GetFromJsonAsync<KitPreviewResponse>($"/api/shop/parts/{key}");
      Bom.Clear();
      if (result?.Components is { Count: > 0 })
      {
        foreach (var entry in result.Components)
        {
          var sku = string.IsNullOrWhiteSpace(entry.Sku) ? "—" : entry.Sku!;
          var name = string.IsNullOrWhiteSpace(entry.Name) ? "Unknown" : entry.Name!;
          Bom.Add(new BomLine(entry.ChildPartId, sku, name, entry.QtyPerParent));
        }
      }
    }
    catch (Exception ex) { PreviewError = ex.Message; }
    finally { PreviewBusy = false; }
  }

  private sealed record BomLine(long ChildPartId, string Sku, string Name, decimal Qty);

  private sealed class KitPreviewResponse
  {
    [JsonPropertyName("components")] public List<KitPreviewComponent> Components { get; set; } = new();
  }
  private sealed class KitPreviewComponent
  {
    [JsonPropertyName("child_part_id")] public long ChildPartId { get; set; }
    [JsonPropertyName("sku")] public string? Sku { get; set; }
    [JsonPropertyName("name")] public string? Name { get; set; }
    [JsonPropertyName("qty_per_parent")] public decimal QtyPerParent { get; set; }
  }
}
